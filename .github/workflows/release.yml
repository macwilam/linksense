name: Release Build

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: true
        default: "0.1.0"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build ${{ matrix.target }} (${{ matrix.variant }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ============ REGULAR BUILDS (no optional features) ============

          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
            use_cross: false
            variant: regular
            features: ""

          # Linux x86_64 (musl - static binary)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-22.04
            use_cross: true
            variant: regular
            features: ""

          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            use_cross: true
            variant: regular
            features: ""

          # Linux ARM64 (musl - static binary)
          - target: aarch64-unknown-linux-musl
            os: ubuntu-22.04
            use_cross: true
            variant: regular
            features: ""

          # Linux ARMv7 (Raspberry Pi)
          - target: armv7-unknown-linux-gnueabihf
            os: ubuntu-22.04
            use_cross: true
            variant: regular
            features: ""

          # macOS x86_64
          - target: x86_64-apple-darwin
            os: macos-13
            use_cross: false
            variant: regular
            features: ""

          # macOS ARM64 (M1/M2/M3/M4)
          - target: aarch64-apple-darwin
            os: macos-14
            use_cross: false
            variant: regular
            features: ""

          # Windows x86_64 (MSVC)
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            use_cross: false
            variant: regular
            features: ""

          # ============ FULL BUILDS (with sql-tasks and snmp-tasks) ============

          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
            use_cross: false
            variant: full
            features: "sql-tasks,snmp-tasks"

          # Linux x86_64 (musl - static binary)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-22.04
            use_cross: true
            variant: full
            features: "sql-tasks,snmp-tasks"

          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            use_cross: true
            variant: full
            features: "sql-tasks,snmp-tasks"

          # Linux ARM64 (musl - static binary)
          - target: aarch64-unknown-linux-musl
            os: ubuntu-22.04
            use_cross: true
            variant: full
            features: "sql-tasks,snmp-tasks"

          # Linux ARMv7 (Raspberry Pi)
          - target: armv7-unknown-linux-gnueabihf
            os: ubuntu-22.04
            use_cross: true
            variant: full
            features: "sql-tasks,snmp-tasks"

          # macOS x86_64
          - target: x86_64-apple-darwin
            os: macos-13
            use_cross: false
            variant: full
            features: "sql-tasks,snmp-tasks"

          # macOS ARM64 (M1/M2/M3/M4)
          - target: aarch64-apple-darwin
            os: macos-14
            use_cross: false
            variant: full
            features: "sql-tasks,snmp-tasks"

          # Windows x86_64 (MSVC)
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            use_cross: false
            variant: full
            features: "sql-tasks,snmp-tasks"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install OpenSSL (Ubuntu native builds with SNMP)
        if: runner.os == 'Linux' && !matrix.use_cross && matrix.variant == 'full'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Install OpenSSL (Windows)
        if: runner.os == 'Windows' && matrix.variant == 'full'
        run: |
          echo "OPENSSL_DIR=C:\Program Files\OpenSSL" >> $env:GITHUB_ENV
          choco install openssl -y

      - name: Install cross (for cross-compilation)
        if: matrix.use_cross
        uses: taiki-e/install-action@cross

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-${{ matrix.target }}-${{ matrix.variant }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-${{ matrix.variant }}-cargo-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.target }}-${{ matrix.variant }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-${{ matrix.variant }}-target-

      - name: Build agent (native)
        if: ${{ !matrix.use_cross && matrix.features == '' }}
        run: cargo build --release --target ${{ matrix.target }} --bin agent

      - name: Build server (native)
        if: ${{ !matrix.use_cross && matrix.features == '' }}
        run: cargo build --release --target ${{ matrix.target }} --bin server

      - name: Build agent with features (native)
        if: ${{ !matrix.use_cross && matrix.features != '' }}
        run: cargo build --release --target ${{ matrix.target }} --bin agent --features "${{ matrix.features }}"

      - name: Build server with features (native)
        if: ${{ !matrix.use_cross && matrix.features != '' }}
        run: cargo build --release --target ${{ matrix.target }} --bin server --features "${{ matrix.features }}"

      - name: Build agent (cross)
        if: ${{ matrix.use_cross && matrix.features == '' }}
        run: cross build --release --target ${{ matrix.target }} --bin agent

      - name: Build server (cross)
        if: ${{ matrix.use_cross && matrix.features == '' }}
        run: cross build --release --target ${{ matrix.target }} --bin server

      - name: Build agent with features (cross)
        if: ${{ matrix.use_cross && matrix.features != '' }}
        run: cross build --release --target ${{ matrix.target }} --bin agent --features "${{ matrix.features }}"

      - name: Build server with features (cross)
        if: ${{ matrix.use_cross && matrix.features != '' }}
        run: cross build --release --target ${{ matrix.target }} --bin server --features "${{ matrix.features }}"

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create release package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TARGET=${{ matrix.target }}
          VARIANT=${{ matrix.variant }}
          RELEASE_DIR="linksense-${VERSION}-${TARGET}-${VARIANT}"

          mkdir -p "$RELEASE_DIR/config-examples"

          # Copy binaries
          cp "target/$TARGET/release/agent" "$RELEASE_DIR/"
          cp "target/$TARGET/release/server" "$RELEASE_DIR/"

          # Strip binaries to reduce size
          if command -v strip &> /dev/null; then
            strip "$RELEASE_DIR/agent" 2>/dev/null || true
            strip "$RELEASE_DIR/server" 2>/dev/null || true
          fi

          # Copy config examples
          cp -r agent/config/* "$RELEASE_DIR/config-examples/" 2>/dev/null || true

          # Create README
          cat > "$RELEASE_DIR/README.md" << EOF
          # LinkSense Network Monitoring System

          **Version:** ${VERSION}
          **Target:** ${TARGET}
          **Variant:** ${VARIANT}
          **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## Variant Information

          $(if [ "$VARIANT" = "full" ]; then
            echo "This is the **full** build with all optional features enabled:"
            echo "- SQL tasks support (PostgreSQL, MySQL, MariaDB)"
            echo "- SNMP tasks support (v1/v2c/v3)"
          else
            echo "This is the **regular** build without optional features."
            echo "For SQL and SNMP monitoring, use the 'full' variant."
          fi)

          ## Quick Start

          ### Agent

          1. Copy config examples: \`cp -r config-examples config\`
          2. Edit \`config/agent.toml\` with your settings
          3. Edit \`config/tasks.toml\` to define monitoring tasks
          4. Run: \`./agent config/\`

          ### Server

          1. Create \`server.toml\` configuration
          2. Run: \`./server server.toml\`

          ## Documentation

          https://github.com/macwilam/linksense
          EOF

          # Copy LICENSE
          cp LICENSE "$RELEASE_DIR/" 2>/dev/null || echo "MIT License" > "$RELEASE_DIR/LICENSE"

          # Create archive
          tar czf "linksense-${VERSION}-${TARGET}-${VARIANT}.tar.gz" "$RELEASE_DIR"
          echo "ASSET=linksense-${VERSION}-${TARGET}-${VARIANT}.tar.gz" >> $GITHUB_ENV
          echo "ASSET_NAME=linksense-${VERSION}-${TARGET}-${VARIANT}" >> $GITHUB_ENV

      - name: Create release package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          $TARGET = "${{ matrix.target }}"
          $VARIANT = "${{ matrix.variant }}"
          $RELEASE_DIR = "linksense-${VERSION}-${TARGET}-${VARIANT}"

          New-Item -ItemType Directory -Force -Path "$RELEASE_DIR\config-examples"

          # Copy binaries
          Copy-Item "target\$TARGET\release\agent.exe" "$RELEASE_DIR\"
          Copy-Item "target\$TARGET\release\server.exe" "$RELEASE_DIR\"

          # Copy config examples
          if (Test-Path "agent\config") {
            Copy-Item -Recurse "agent\config\*" "$RELEASE_DIR\config-examples\" -ErrorAction SilentlyContinue
          }

          # Create README
          $variantInfo = if ($VARIANT -eq "full") {
            "This is the **full** build with all optional features enabled:`n- SQL tasks support (PostgreSQL, MySQL, MariaDB)`n- SNMP tasks support (v1/v2c/v3)"
          } else {
            "This is the **regular** build without optional features.`nFor SQL and SNMP monitoring, use the 'full' variant."
          }

          @"
          # LinkSense Network Monitoring System

          **Version:** $VERSION
          **Target:** $TARGET
          **Variant:** $VARIANT
          **Build Date:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss") UTC

          ## Variant Information

          $variantInfo

          ## Quick Start

          ### Agent

          1. Copy config examples to a config folder
          2. Edit config\agent.toml with your settings
          3. Edit config\tasks.toml to define monitoring tasks
          4. Run: agent.exe config\

          ### Server

          1. Create server.toml configuration
          2. Run: server.exe server.toml

          ## Documentation

          https://github.com/macwilam/linksense
          "@ | Out-File -FilePath "$RELEASE_DIR\README.md" -Encoding utf8

          # Copy LICENSE
          if (Test-Path "LICENSE") {
            Copy-Item "LICENSE" "$RELEASE_DIR\"
          } else {
            "MIT License" | Out-File -FilePath "$RELEASE_DIR\LICENSE" -Encoding utf8
          }

          # Create zip archive
          Compress-Archive -Path "$RELEASE_DIR" -DestinationPath "linksense-${VERSION}-${TARGET}-${VARIANT}.zip"
          "ASSET=linksense-${VERSION}-${TARGET}-${VARIANT}.zip" | Out-File -FilePath $env:GITHUB_ENV -Append
          "ASSET_NAME=linksense-${VERSION}-${TARGET}-${VARIANT}" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ASSET_NAME }}
          path: ${{ env.ASSET }}
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Generate checksums
        run: |
          cd release-assets
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          generate_release_notes: true
          body: |
            ## Download Options

            ### Regular builds
            Standard builds without SQL and SNMP monitoring features.

            ### Full builds
            Includes all optional features:
            - **SQL tasks**: Monitor PostgreSQL, MySQL, MariaDB databases
            - **SNMP tasks**: Query SNMP-enabled network devices (v1/v2c/v3)

            ### Platforms
            | Platform | Architecture | Notes |
            |----------|-------------|-------|
            | Linux GNU | x86_64, ARM64, ARMv7 | Requires glibc |
            | Linux musl | x86_64, ARM64 | Static binary, no dependencies |
            | macOS | x86_64, ARM64 | Intel and Apple Silicon |
            | Windows | x86_64 | MSVC build |

            ### Verification
            Verify downloads using SHA256SUMS.txt:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
